name: Publish Docker

on: 
  push:
        branches: 
        - '**'
  pull_request:
         branches:
             - 'master'
jobs:
  docker:
    runs-on: ubuntu-latest
    steps:
      - uses: FranzDiebold/github-env-vars-action@v2
      - name: Set Environment Variables
        run: |
            IMG=nusak/nusak
            echo "IMG=${IMG}" >> $GITHUB_ENV
            echo "BUILD_VER=v0.0.$GITHUB_RUN_NUMBER" >> $GITHUB_ENV
            echo "SHA=${CI_SHA_SHORT}" >> $GITHUB_ENV
            echo "REF=${CI_ACTION_REF_NAME_SLUG}" >> $GITHUB_ENV
      -
        name: Print Env Vars
        run: |
          echo "GITHUB_ACTOR=$GITHUB_ACTOR"
          echo "GITHUB_REPOSITORY=$GITHUB_REPOSITORY"
          echo "GITHUB_SHA=$GITHUB_SHA"
          echo "GITHUB_REF=$GITHUB_REF"
          echo "GITHUB_HEAD_REF=$GITHUB_HEAD_REF"
          echo "GITHUB_BASE_REF=$GITHUB_BASE_REF"
          echo "GITHUB_EVENT_NAME=$GITHUB_EVENT_NAME"
          echo "GITHUB_RUN_ID=$GITHUB_RUN_ID"
          echo "GITHUB_RUN_NUMBER=$GITHUB_RUN_NUMBER"
          echo "GITHUB_WORKFLOW=$GITHUB_WORKFLOW"
          echo "GITHUB_ACTION=$GITHUB_ACTION"
          echo "GITHUB_BUILD_VERS=$GITHUB_BUILD_VERS"
          echo "GITHUB_REF=$GITHUB_REF"
          echo "GITHUB_SHA=$GITHUB_SHA"
          echo "GITHUB_IMG=$GITHUB_IMG"
      -
        name: Checkout
        uses: actions/checkout@v2
      - 
        name: Set up QEMU
        uses: docker/setup-qemu-action@v1
      -
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      -
        name: Login to DockerHub
        uses: docker/login-action@v1 
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      -
        name: Build and push
        uses: docker/build-push-action@v2
        with:
          context: .
          platforms: linux/amd64, linux/arm64
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
              ${{ env.IMAGE }}:${{ env.GIT_REF }}
              ${{ env.IMAGE }}:${{ env.GIT_SHA }}
              ${{ env.IMAGE }}:${{ env.GIT_BUILD_VER }}

         
